select
--  iz.ITEMZ_ID as ITEMZ_ID,
  ix.ITEMX_ID as "Позиция плана",
  (select v_sta.status_name from v_status v_sta where ix.ITEMX_STATUS_CODE=v_sta.status_code  ) as "Стат. поз. плана",
  (select v_so.source_SNAME from vpc_source v_so where ix.ITEMX_SOURCE_ID=v_so.SOURCE_ID  )  as "Тип данных",
  (select bp.BPRODUCT_NAME from vpc_bproduct bp where ix.ITEMX_BPRODUCT_ID=bp.BPRODUCT_ID  ) as "Наим продукта",
  (select xm.XMOD_NUMB from vpc_xmod xm where ix.ITEMX_XMOD_ID=xm.XMOD_ID  ) as "Номер рас. мод.",
  (select xm.XMOD_NAME from vpc_xmod xm where ix.ITEMX_XMOD_ID=xm.XMOD_ID  ) as "Дл. имя рас. мод.",
  (select cfo.DEPT_NAME  from vpc_dept cfo where ix.ITEMX_CFO_ID=cfo.DEPT_ID   ) as "Дл. имя ЦФО",
  (select ckk.DEPT_NAME  from vpc_dept ckk where ix.ITEMX_CKK_ID=ckk.DEPT_ID   ) "Дл. имя ЦКК",
  (select cpk.DEPT_NAME  from vpc_dept cpk where ix.ITEMX_CPK_ID=cpk.DEPT_ID   ) "Дл. имя ЦПК",
  co.DEPT_NAME as "Дл. имя ЦО",
  (select ol.OLDNEW_NAME from vpc_oldnew ol where   ix.ITEMX_OLDNEW_CODE=ol.OLDNEW_ID ) as "Имя типа данных",
  (select kind.KINDOFPLAN_NAME  from vpc_kindofplan kind where ix.ITEMX_KINDOFPLAN_ID=kind.KINDOFPLAN_ID  ) as "Имя вида плана",
  (select proj.PROJECT_NAME from vpc_project proj  where ix.ITEMX_PROJECT_ID=proj.PROJECT_ID   ) "Имя сегмента опер",
  (select projr.PROJECT_NAME from vpc_project projr where ix.ITEMX_PROJECTREP_ID=projr.PROJECT_ID  ) as "Имя сегмента отчета",
  (select projr.PROJECT_NAME from vpc_project projr where projr.PROJECT_level=2 and projr.PROJECT_SSS =
  (select substr(pro.PROJECT_SSS,1,24) from vpc_project pro where pro.PROJECT_ID=ix.ITEMX_PROJECTREP_ID ) ) as "ГБЛ",
  (select prm.PERIM_NAME from vpc_perim prm where ix.ITEMX_PERIM_ID=prm.PERIM_ID   ) as "Имя периметра",
  (select mir.MIRCD_CODE from vpc_mircd mir where ix.ITEMX_MIRCD_ID=MIR.MIRCD_ID   ) as "MIR-код",
  (select xc.XCURR_COD from vpc_xcurr xc  where ix.ITEMX_XCURR_ID=xc.XCURR_ID    ) as "Короткое имя валюты",
  xcf.XCURR_COD as "Функциональная валюта",
  (select sro.SROCHNOST_NAME from vpc_srochnost sro where ix.ITEMX_SROCHNOCT_ID=sro.SROCHNOST_ID ) as "Имя срочности",
  (select vcom.COM_CRM_ID  from vpc_com vcom  where  ix.ITEMX_XCOM_ID=vcom.COM_ID ) as "CRM-код клиента",
  (select vcom.COM_NAME from vpc_com vcom  where  ix.ITEMX_XCOM_ID=vcom.COM_ID ) as "Имя клиента",
  (select cli.CLITYPE_NAME from vpc_clitype cli where  ix.ITEMX_CLITYPE_ID=cli.CLITYPE_ID ) as "Тип клиента",
  (select clic.CLICATEGORY_NAME from vpc_clicategory clic  where ix.ITEMX_CLICATEGORY_ID=clic.CLICATEGORY_ID ) as "Категория клиента",
  (select cind.CLIINDUSTRY_NAME from vpc_cliindustry cind  where ix.ITEMX_CLIINDUSTRY_ID=cind.CLIINDUSTRY_ID  ) as "Отрасль клиента",
  (select crate.CLIRATE_NAME from vpc_clirate crate     where ix.ITEMX_CLIRATE_ID=crate.CLIRATE_ID ) as  "Рейтинг клиента",
  (select resi.RESIDENT_NAME from vpc_resident resi  where  ix.ITEMX_RESIDENT_CODE=resi.RESIDENT_ID ) as  "Резидент. клиента",
  (select prb.PROBL_NAME from vpc_probl prb  where ix.ITEMX_PROBL_ID=prb.PROBL_ID   ) as "Проблемность",
  (select vy.yesno_name from v_yesno vy  where ix.ITEMX_INGRP=vy.yesno_code  ) as "Внутригрупповая сделка",
  (select v_base.base_name from v_base v_base  where ix.ITEMX_BASE_CODE=v_base.base_code  ) as "База расчета",
  nvl(fl.flrate_name,' ') as "Вид баз. ставки",

  ' ' as e1,
  nvl(
     (SELECT vb.babd_id || '#' || vb.BABD_NAME || '#' ||
     (select r.activ_passiv_name from vpc_activ_passiv r where r.activ_passiv_id=vb.BABD_ACTIV_PASSIV)
       FROM tmp_report_cub vb
       where vb.itemi_id=iz.ITEMZ_ITEMI_ID
       and vb.xmod_id=ix.ITEMX_XMOD_ID
       and vb.bproduct_id=ix.ITEMX_BPRODUCT_ID
       and vb.ingrp=ix.ITEMX_INGRP
       and (vb.BABD_BALANCE_BUDGET=1 Or vb.BABD_BALANCE_BUDGET=3 Or vb.BABD_BALANCE_BUDGET=5)
       and vb.babd_uu_msfo=1),'Нет#Нет#Нет') as "Код статьи баланса УУ",
  ' ' as e2,
  nvl(
     (SELECT vb.babd_id || '#' || vb.BABD_NAME || '#' ||
     (select r.dohod_rashod_name from vpc_dohod_rashod r where r.dohod_rashod_id=vb.BABD_DOHOD_RASHOD)
       FROM tmp_report_cub vb
       where vb.itemi_id=iz.ITEMZ_ITEMI_ID
       and vb.xmod_id=ix.ITEMX_XMOD_ID
       and vb.bproduct_id=ix.ITEMX_BPRODUCT_ID
       and vb.ingrp=ix.ITEMX_INGRP
       and (vb.BABD_BALANCE_BUDGET=2 Or vb.BABD_BALANCE_BUDGET=4)
       and vb.babd_uu_msfo=1),'Нет#Нет#Нет') as "Код статьи бюджета УУ",
  ' ' as e3,
  nvl(
     (SELECT vb.babd_id || '#' || vb.BABD_NAME || '#' ||
     (select r.activ_passiv_name from vpc_activ_passiv r where r.activ_passiv_id=vb.BABD_ACTIV_PASSIV)
       FROM tmp_report_cub vb
       where vb.itemi_id=iz.ITEMZ_ITEMI_ID
       and vb.xmod_id=ix.ITEMX_XMOD_ID
       and vb.bproduct_id=ix.ITEMX_BPRODUCT_ID
       and vb.ingrp=ix.ITEMX_INGRP
       and (vb.BABD_BALANCE_BUDGET=1 Or vb.BABD_BALANCE_BUDGET=3 Or vb.BABD_BALANCE_BUDGET=5)
       and vb.babd_uu_msfo=2),'Нет#Нет#Нет') as "Код статьи баланса МСФО",
  ' ' as e4,
  nvl(
     (SELECT vb.babd_id || '#' || vb.BABD_NAME || '#' ||
     (select r.dohod_rashod_name from vpc_dohod_rashod r where r.dohod_rashod_id=vb.BABD_DOHOD_RASHOD)
       FROM tmp_report_cub vb
       where vb.itemi_id=iz.ITEMZ_ITEMI_ID
       and vb.xmod_id=ix.ITEMX_XMOD_ID
       and vb.bproduct_id=ix.ITEMX_BPRODUCT_ID
       and vb.ingrp=ix.ITEMX_INGRP
       and (vb.BABD_BALANCE_BUDGET=2 Or vb.BABD_BALANCE_BUDGET=4)
       and vb.babd_uu_msfo=2),'Нет#Нет#Нет') as "Код статьи бюджета МСФО",
  pl.PLNPER_FULLNAME as "Полное имя периода",
  ii.ITEMI_NAME as "Наименование показателя",
  iz.itemz_val as "Знач пок в валюте поз плана",
  iz.itemz_val_base as "Знач пок в функц валюте",
  iz.itemz_val2_base as "Знач пок в базовой валюте",
  (select vup.upload_from_name from v_upload_from vup where ix.ITEMX_UPLOAD_FROM_CODE=vup.upload_from_code  )  as "Источник загрузки",
  (select usin.usr_las_name || ' ' || usin.usr_fir_name || ' ' || usin.usr_mid_name from usr usin where ix.ITEMX_IN_USR_ID=usin.usr_id)  as "Кто вставил",
  ix.ITEMX_IN_DATE as "Когда вставил",
  (select usred.usr_las_name || ' ' || usred.usr_fir_name || ' ' || usred.usr_mid_name from usr usred where ix.ITEMX_CORR_USR_ID=usred.usr_id  ) as "Кто изменил",
  ix.ITEMX_CORR_DATE  as "Когда изменил",
       nvl(nt2.note2itemx_txt, '-')
       as "Примечания",
   (select xv.xver_name from vpc_xver_allxver xv  where ix.itemx_xver_id=xv.xver_id   ) as "Код версии",
CASE
 WHEN (ix.ITEMX_UPLOAD_FROM_CODE = 7) THEN ix.ITEMX_NUMB
 ELSE
    nvl (
    (select to_char(ids.ITEMX_ID)
  from VPC_ITEMX_ALLXVER ids
  where ids.ITEMX_UPLOAD_FROM_CODE=7
  and ids.ITEMX_XVER_ID=ix.ITEMX_XVER_ID
  and ids.ITEMX_NUMB=to_char(ix.ITEMX_ID)),0)
END as "ID позиции сторно",
 CASE
  WHEN (ix.ITEMX_UPLOAD_FROM_CODE = 11) THEN ix.ITEMX_NUMB
  ELSE
   nvl (
    (select to_char(ids.ITEMX_ID)
   from VPC_ITEMX_ALLXVER ids
   where ids.ITEMX_UPLOAD_FROM_CODE=11
  and ids.ITEMX_XVER_ID=ix.ITEMX_XVER_ID
  and ids.itemx_ingrp = 1 and ids.itemx_oldnew_code <> 15
   and ids.ITEMX_NUMB=to_char(ix.ITEMX_ID)),0)
 END as "ID связанной позиции ВГО",
CASE     WHEN ix.ITEMX_XCORR_CONNECT_ID IS NOT NULL AND ix.ITEMX_XCORR_CONNECT_ID > 0 THEN ix.ITEMX_XCORR_CONNECT_ID
WHEN (ix.ITEMX_XCORR_CONNECT_ID IS NULL OR (ix.ITEMX_XCORR_CONNECT_ID IS NOT NULL AND ix.ITEMX_XCORR_CONNECT_ID=0)) AND itemx_indgrf =-1 THEN -1
WHEN (ix.ITEMX_XCORR_CONNECT_ID IS NULL OR (ix.ITEMX_XCORR_CONNECT_ID IS NOT NULL AND ix.ITEMX_XCORR_CONNECT_ID=0)) AND itemx_indgrf <>-1 THEN itemx_indgrf
ELSE NULL   END as "CONNECT_ID",
  nvl((select vp_cor.correction_number from vpc_correction vp_cor where ix.itemx_correction_id=vp_cor.CORRECTION_ID),' ') as "Номер корректировки",
  ' ' as "Актив/Пассив УУ",
  ' ' as "Доход/Расход УУ",
 ' ' as "Актив/Пассив МСФО",
 ' ' as "Доход/Расход МСФО",
  ix.ITEMX_FORM_ID as "Номер загрузки",
 case
 when ix.ITEMX_UPLOAD_FROM_CODE in (1,29) then
 (select upl_real_file_name
  from upload
  where upl_id=
  ( select uplf_upload_id
    from upload_form
    where uplf_id=ix.ITEMX_FORM_ID
  )
 )
 when ix.ITEMX_UPLOAD_FROM_CODE=3 then
 (select upload_from_name
  from v_upload_from
  where upload_from_code=3)
 else '-'
 end as "Имя загрузочного файла",
case
when exists (select t.ITEMZ_ID
from vpc_itemz t
where t.ITEMZ_ITEMX_ID=ix.ITEMX_ID and t.ITEMZ_PLNPER_ID=iz.ITEMZ_PLNPER_ID
and t.ITEMZ_ITEMI_ID=666 and t.ITEMZ_VAL_BASE=1) then 1
else 0
end as NPL,
  nvl( (select t.evalcateg_name from v_evalcateg t where t.evalcateg_id=ix.ITEMX_EVALCATEG_ID)
,'Отсутствует') as "Категория оценки",
  nvl( (select u.portfolio_name from v_portfolio u where u.portfolio_id=ix.ITEMX_PORTFOLIOXMOD_ID)
,'Отсутствует') as "Категория обесценения",
  ii.ITEMI_INDGRP_CODE,
  ii.ITEMI_ID
 , NVL(ia.ias_numb, 'Нет')   , NVL(ia.ias_name, 'Нет')  , (select z.actu_code from Z2ACTU z where z.z2actu_actu_id= ix.ITEMX_XCORR_DEPT_ID AND z.z2actu_plncomp_id=200190 and z.actu_source_id=ix.ITEMX_SOURCE_ID  ) as MA
from
  VPC_ITEMX_ALLXVER ix,
  vpc_itemz iz,
  vpc_itemi ii,
  vpc_plnper_short pl,
  vpc_dept co,
  vpc_xcurr xcf,
  vpc_flrate fl,
  vpc_plncomp pln,
  vpc_xcurr xc2,
  vpc_note2itemx nt2
  ,TMP_IAS2IND ias   ,vpc_ias ia

where ix.itemx_id=iz.itemz_itemx_id
 and iz.ITEMZ_ITEMI_ID!=666
 and iz.ITEMZ_PLNPER_ID=pl.PLNPER_ID
 and ix.ITEMX_CO_ID=co.DEPT_ID
 and co.DEPT_FXCURR_ID=xcf.XCURR_ID
 and ix.ITEMX_FLRATE_ID=fl.flrate_id(+)
 and iz.ITEMZ_ITEMI_ID=ii.ITEMI_ID
 and ix.ITEMX_PLNCOMP_ID=pln.PLNCOMP_ID
 and pln.PLNCOMP_XCURR_ID=xc2.XCURR_ID
 and ix.ITEMX_ID=nt2.note2itemx_itemx_id(+)

 AND iz.ITEMZ_ITEMI_ID = ias.ias2ind_itemi_id(+)  AND ix.ITEMX_XMOD_ID = ias.ias2ind_xmod_id(+) AND ix.ITEMX_BPRODUCT_ID = ias.ias2ind_bproduct_id(+)  AND ix.ITEMX_EVALCATEG_ID = ias.ias2ind_evalcateg_id(+)  AND ias.ias2ind_ias_id = ia.ias_id(+)

-- Подразделения

--Статус

-- ЦФО
-- ЦКК
-- ЦПК
-- ЦО
-- Продукт
-- Вид плана
-- Подтип данных
-- Клиент
-- Тип клиента
-- Категория клиента
-- Отрасль клиента
-- Рейтинг клиента
-- Резидентность клиента
-- Валюта позиции плана
-- Срочность
-- Операционный сегмент
-- Отчетный сегмент
-- Периметр
-- Финансовый показатель
-- Расчетная модель
-- Период
and iz.ITEMZ_PLNPER_ID in (200613,200614)
-- Проблемность
-- Внутригрупповая сделка
--Номер загрузки
--Номер загрузки
-- Признак NPL
-- Категория оценки
-- Категория обесценения
-- Номер позиции плана
-- MIR-код
-- CRM-код
-- Кто загр
-- Версионность
and ix.itemx_xver_id in (2141,2142)
-- Номер корректировки
-- Пустые позиции <47>
-- Статья
order by 1

